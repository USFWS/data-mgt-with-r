<!DOCTYPE html>
<html lang="" xml:lang="">
  <head>
    <title>R tools for a code-based data workflow</title>
    <meta charset="utf-8" />
    <meta name="author" content="McCrea Cobb and Adam Smith" />
    <meta name="date" content="2020-06-08" />
    <link href="libs/font-awesome/css/fontawesome-all.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="xaringan-themer.css" type="text/css" />
    <link rel="stylesheet" href="my-theme.css" type="text/css" />
  </head>
  <body>
    <textarea id="source">








background-image: url(images/an-image.jpg)
background-size: contain
class: hide-logo, center, middle, inverse
# ![:scale 9%](images/Rlogo.svg) Tools for a Code-based Data Workflow

.pull-left[
`McCrea Cobb`  
<i class="fas  fa-envelope "></i> mccrea_cobb@fws.gov  
<i class="fas  fa-phone "></i> 907-786-3403  
<i class="fab  fa-github "></i> mccrea.cobb  
]

.pull-right[
`Adam D. Smith`  
<i class="fas  fa-envelope "></i> adam_d_smith@fws.gov  
<i class="fas  fa-phone "></i> 706-425-2197  
<i class="fab  fa-github "></i> adamdsmith  
]

&lt;br&gt;

<i class="fab  fa-github "></i> usfws.github.io/data-mgt-with-r/

---
class: inverse, center, middle, hide-logo
# Outline


---
class: inverse, center, middle, hide-logo
# Outline

*Review the data life cycle and data workflow*


---
class: inverse, center, middle, hide-logo
# Outline

Review the data life cycle and data workflow

*Present some tools in R for efficiently and effectively working with data along the life cycle*


---
class: inverse, center, middle, hide-logo
# Outline

Review the data life cycle and data workflow

Present some tools in R for efficiently and effectively working with data along the life cycle

*Demonstrate a data workflow in R using an example project*


???
- What we will cover
  - Introduce some tools in R that can be used for a data workflow. 
  - We take a scientific data focus, but the tools that we introduce can be used for all types of data.

- Disclaimer: What we won't cover
  - This is not an "Intro to R", how to get your data into R, etc
    - There are many free online courses that cover these materials
      - DataCamp
      - NCTC courses
- Take home message: It is possible to use a scripting languaging like R to complete your data workflow that follows the data life cycle. Doing this is more efficient and less error prone than a manual data workflow commonly used.


---
background-image: url(images/draw_owl-kosher.jpg)
background-size: contain
class: hide-logo

???


---
# Project and data life cycles

.center[![:scale 80%](images/life_cycles.png)]


???
- Here's some notes


---
background-image: url(images/life_cycles-data.png)
background-size: 90%
class: hide-logo


???
- There are many versions of the data life cycle


---
background-image: url(images/criteria_grouped3.png)
background-size: 70%
class: hide-logo


???
- Here are some criteria that can be used to evaluate your data workflow

+ The manual data workflow
  + Example
  + Limitations
+ The code-based data workflow
  + Advantages
    + Documented
    + Reproducible
    + Replicable
    + More efficient
    + Less error-prone
    

---
background-image: url(images/traditional_workflow_1.png)
background-size: 90%
class: hide-logo
# Traditional data workflow


???


---
background-image: url(images/traditional_workflow_2.png)
background-size: 90%
class: hide-logo
# Traditional data workflow


???


---
background-image: url(images/traditional_workflow_3.png)
background-size: 90%
class: hide-logo
# Traditional data workflow


???


---
background-image: url(images/traditional_workflow_4.png)
background-size: 90%
class: hide-logo
# Traditional data workflow


???


---
background-image: url(images/traditional_workflow_5.png)
background-size: 90%
class: hide-logo
# Traditional data workflow


???


---
background-image: url(images/traditional_workflow_6.png)
background-size: 90%
class: hide-logo
# Traditional data workflow <i class="fas  fa-frown-open "></i>


???
Disadvantages  
- Not reproducible
- They are seperate from the code that you used to create your analysis and figures.
- They are time-consuming to create and difficult to maintain.

---
background-image: url(images/workflow.gif)
background-size: contain
class: hide-logo


???
- What we need is a seamless workflow like this, where the data go from acquiring to process (and archiving).
- Your code should be the soruce of your products (report, etc). Based on your code. 


---
background-image: url(images/r_workflow_1.png)
background-size: 90%
class: hide-logo
# ![:scale 7%](images/Rlogo.svg) data workflow 


???


---
background-image: url(images/r_workflow_2.png)
background-size: 90%
class: hide-logo
# ![:scale 7%](images/Rlogo.svg) data workflow <i class="fas  fa-smile "></i>


???


---
background-image: url(images/r_workflow_3.png)
background-size: 90%
class: hide-logo
# ![:scale 7%](images/Rlogo.svg) data workflow <i class="fas  fa-grin "></i>


???


---
background-image: url(images/r_workflow_4.png)
background-size: 90%
class: hide-logo
# ![:scale 7%](images/Rlogo.svg) data workflow <i class="fas  fa-grin "></i>


???


---
background-image: url(images/r_workflow_5.png) 
background-size: 90%
class: hide-logo
# ![:scale 7%](images/Rlogo.svg) data workflow <i class="fas  fa-grin-beam "></i>


???


---
background-image: url(images/r_workflow_6.png)
background-size: 90%
class: hide-logo
# ![:scale 7%](images/Rlogo.svg) data workflow <i class="fas  fa-grin-beam "></i>


???


---
background-image: url(images/r_workflow_7.png)
background-size: 90%
class: hide-logo
# ![:scale 7%](images/Rlogo.svg) data workflow <i class="fas  fa-grin-squint "></i>


???

---
background-image: url(images/r_workflow_8.png)
background-size: 90%
class: hide-logo
# ![:scale 7%](images/Rlogo.svg) data workflow <i class="fas  fa-grin-squint "></i>


???

---
background-image: url(images/r_workflow_9.png)
background-size: 90%
class: hide-logo
# ![:scale 7%](images/Rlogo.svg) data workflow <i class="fas  fa-grin-stars "></i>


???

---
background-image: url(images/r_workflow_10.png)
background-size: 90%
class: hide-logo
# ![:scale 7%](images/Rlogo.svg) data workflow <i class="fas  fa-grin-stars "></i>


???


---
background-image: url(images/Rlogo.svg)
class: hide-logo


???
- Why use R?
  - Free for everybody
  - Relatively easy to learn (compared to other programming languages)
  - Popular
  - Powerful
  - Flexible
    - statistical analyses
    - graphics
    - reporting
  - Active community of users
    - stackoverflow
    - package development
    - GitHub integration
  - Nice free integrated development environment (RStudio)
  

---
class: center, middle, inverse
# Planning

![](images/life_cycles-data_planning.png)


???


---
# Organizing an ![:scale 7%](images/Rlogo.svg) project 

### <i class="fas  fa-sitemap "></i> Chose a  standardized file directory structure

.pull-left[
- Provides consistent relative directory paths for your scripts.

- R packages provide functions to create a standard file directory
    - [`MakeProject::MakeProject()`](https://cran.r-project.org/web/packages/makeProject/index.html)
    - [`rrtools::use_analysis()`](https://www.rdocumentation.org/packages/rrtools/versions/0.1.0)
    - [`refugetools::create.dir()`](https://github.com/USFWS/refugetools)
    - [`prodigenr::setup_project()`](https://cran.r-project.org/web/packages/prodigenr/readme/README.html)

  
]

.pull-right[
An example file directory:

```r
project_name/
  admin/
* code/
    functions/
* data/
    derived_data/
    raw_data/
  incoming/
  metadata/
  output/
    figures/
    raw_analysis/
    tables/
  products/
  resources/
*   data/
    publications/
    reports/
```
]


???
- There are packages that produce a standardized directory structure
    - Examples: 
        - SppDistMonProj:: dir_create()


---
# Organizing an ![:scale 7%](images/Rlogo.svg) project 

### <i class="fas  fa-file-signature "></i> Decide on a standardized file naming convention

.pull-left[
- Call files what they are
- Keep names short
- Avoid spaces
- If dates are used, use YYYYMMDD
- Decide on a standard
    - e.g., ****camelCase, snake_case, PascelCase, kebab-case***

Allows you to programmatically filter files:
]

.pull-right[
![](images/naming-conventions.png)
]


```r
# Exclude files with 2016 or 2017 in their names
f &lt;- list.files(path = "./filepath", 
*               pattern = "[^2016|2017].csv$")

# Load these files
dat &lt;- lapply(f, read.csv)
```

???


---
# ![:scale 10%](images/standardized_circle_text.png) Organizing an ![:scale 8%](images/Rlogo.svg) project 

### Consult a style guide

"Good coding style is like correct punctuation: you can manage without it, butitsuremakesthingseasiertoread"  -[Hadley Wickham](https://style.tidyverse.org/index.html)

.pull-left[
- Strive for consistent and meaningful names
- Review existing style guides:
  - [tidyverse style guide](https://style.tidyverse.org/)
  - [Advanced R style guide](http://adv-r.had.co.nz/Style.html)
  - [Google's R style guide](https://google.github.io/styleguide/Rguide.html)
- Helpful R packages:
  - `styler` 
  - `lintr`
]

.pull-right[

```r
# R code readability

if(readability()) {
  be_happy()
} else {
  rewrite_code()
}
```
]

???

- Strive for consistent and meaningful names
  - file names
  - syntax
    - object names, spacing, long lines, assignments, comments
  - functions
    - naming, return()
    
- Google style guide
- Hadley Wickham's style guide

Two R packages support this style guide:

styler allows you to interactively restyle selected text, files, or entire projects. It includes an RStudio add-in, the easiest way to re-style existing code.

lintr performs automated checks to confirm that you conform to the style guide.


---
# [`styler` package](https://github.com/r-lib/styler)

Can be used to format R code to a specific style. 

Flexible for user to specific their own style.


```r
# Before
some_data =data_frame(small= 2 ,
                      medium =4,#comment without space
                      large=6   
)
```


```r
# After style_text(...)

some_data &lt;- data_frame(
  small = 2,
  medium = 4, # comment without space
  large = 6
)
```

???
- 


---
# <i class="fas  fa-people-carry "></i> Project portability

.left-column[
![:scale 50%](images/packrat_logo.png)
]

.right-column[
![:scale 100%](images/package-hell.png)

Isolated

Portable

Reproducible
]

???

- Isolated: 
  - Installing a new or updated package for one project won’t break your other projects, and vice versa. That’s because packrat gives each project its own private package library.
- Portable: 
  - Easily transport your projects from one computer to another, even across different platforms. Packrat makes it easy to install the packages your project depends on.
- Reproducible:
  - Packrat records the exact package versions you depend on, and ensures those exact versions are the ones that get installed wherever you go.

- Available tools:
  - packrat
  - rocker
    - Docker is a program that allows to manipulate (launch and stop) multiple operating systems (called containers) on your machine (your machine will be called the host).
    - you can use older versions of a package for a specific task, while still keeping the package on your machine up-to-date.


---
# ![:scale 8%](images/packrat_logo.png)


???


---
# <i class="fas  fa-code-branch "></i> Version control 

.pull-left[
Consider how you will control versions **during the planning step**.

References
- Resources to learn git [(link)](https://try.github.io/)
- Using git from RStudio [(link)](https://nceas.github.io/oss-lessons/version-control/4-getting-started-with-git-in-RStudio.html)
]

.pull-right[
![](images/git_logo.png)
]

---
# <i class="fas  fa-code-branch "></i> Version control 


.pull-right[
.center[![:scale 50%](images/github.svg)]
.center[![:scale 50%](images/github-logo.png)]
]


???


---

&lt;video controls autoplay width="800" height="500" controls&gt;
  &lt;source src="images/clone_repo.mp4" type="video/mp4"&gt;
&lt;/video&gt;

???
- Version control is.. 
- You should consider how you will be managing the version history of your work during the planning stage.
- Git is a popular version control software and GitHub is a companion website.
  - Allows for collaboration as well.
- GitHub is popular with R users because it interfaces with package development


---
class: center, middle, inverse, hide-logo
# Documenting

![](images/life_cycles-data_documenting.png)

---
# Documenting R object

(image of commented header)
(image of Roxygen header)

???
- This is the metadata for your scripts

- In the simplest case, add a commented header to your R scripts
- For reusable functions, consider inserting an Roxygen header (Ctl-Alt-Shift-R)
    - one less step when bundling your functions into a package.


---
# Roxygen comments

- Metadata for functions
  - Describes the purpose of the function, parameter values (`@params`), what is returned (`@return`), and how to use it (`@example`)


.small[

```r
#' Calculate estimated proportion of sites at which a species occurs
#'
#' @param topmod object of class \code{unmarkedFitOccu} for single-species 
#' occupancy model
#' @param stat statistic (\code{mean} or \code{median}) used to 
#' summarize posterior distribution
#' @param n number of sites surveyed
#'
#' @return vector containing posterior mean or median and upper and lower 95% 
#' confidence limits
#'
#' @export
#'
#' @example calc.pao(topmod, stat = "mean", n = 30)

calc.pao &lt;- function(topmod, stat = "mode", n){
    re = unmarked::ranef(topmod)
    EBUP = unmarked::bup(re, stat = stat)
    CI = confint(re, level = 0.95)
    PAO = c(Estimate = sum(EBUP), colSums(CI))
    PAO / n
}
```
]


---
class: center, middle, inverse, hide-logo
# Acquiring

![](images/life_cycles-data_acquiring.png)


???


---
class: center, middle, inverse, hide-logo
# Processing and Analyzing


![](images/life_cycles-data_process_analyzing.png)


???


---
class: center, middle, inverse, hide-logo
# Sharing and Archiving

![](images/life_cycles-data_share-archiving.png)


???
???

Unlike cumbersome word processing applications, text written in Markdown can be easily shared between computers, mobile phones, and people. It’s quickly becoming the writing standard for academics, scientists, writers, and many more. Websites like GitHub and reddit use Markdown to style their comments.

Formatting text in Markdown has a very gentle learning curve. It doesn’t do anything fancy like change the font size, color, or type. All you have control over is the display of the text—stuff like making things bold, creating headers, and organizing lists.

- RMarkdown
  - Types of output
    - html
    - pdf
    - dashboards
    - websites
  - Examples
    - Bat reporting for mobile aucistics
    - COVID 19 example
    

---
# ![:scale 5%](images/rmarkdown_logo.png) Rmarkdown
You can generate reports directly from RStudio!

.left-column[
**Allows for:**
- Code to be directly inserted into document

- Multiple outputs

- Easy to use

- Increased reproducibility

- Fewer sources of errors

]

.right-column[
.center[![:scale 100%](images/rmarkdown_workflow2.png)]
]


???


---
# ![:scale 5%](images/rmarkdown_logo.png) Example


???
Here's an example of how to generate an Rmarkdown document


---
# ![:scale 5%](images/xaringan_logo.png) Presentations 

.center[![:scale 80%](images/rmarkdown_presentation.png)]

???
As mentioned earlier, Rmarkdown documents can be rendered into multiple different formats.
You can create presentations, such as this one!


---
# ![:scale 5%](images/shiny.png) Web applications 


???
You can also generate interactive content from R, such as websites and dashboards. The Shiny package allows for these, which can also be imbedded into Rmarkdown outputs.


---
background-image: url(images/collar_viewer.png)
background-size: contain
class: hide-logo


???
- Shiny apps
    - Examples
      - collarviewer
      - power analysis for butterfly surveys


---
# <i class="fas  fa-file-archive "></i> Archiving 


???
- You can include code to save your data and products in a remote secure repository.
- For example, instead of manually opening ServCat and saving your reports to as a product in a ServCat record, it is possible to use R code to save results to ServCat. 
- This is an active area of development.
- I encourage you to reach out to your data managers and ServCat managers to look into this more.

---
class: center, middle, inverse, hide-logo
# Demo &lt;br&gt; <i class="fas  fa-walking "></i> <i class="fas  fa-desktop "></i> 


???


---
class: center, middle, inverse, hide-logo
# Questions
    </textarea>
<style data-target="print-only">@media screen {.remark-slide-container{display:block;}.remark-slide-scaler{box-shadow:none;}}</style>
<script src="https://remarkjs.com/downloads/remark-latest.min.js"></script>
<script src="macros.js"></script>
<script>var slideshow = remark.create({
"highlightStyle": "github",
"highlightLines": true,
"countIncrementalSlides": false,
"ratio": "16:9"
});
if (window.HTMLWidgets) slideshow.on('afterShowSlide', function (slide) {
  window.dispatchEvent(new Event('resize'));
});
(function(d) {
  var s = d.createElement("style"), r = d.querySelector(".remark-slide-scaler");
  if (!r) return;
  s.type = "text/css"; s.innerHTML = "@page {size: " + r.style.width + " " + r.style.height +"; }";
  d.head.appendChild(s);
})(document);

(function(d) {
  var el = d.getElementsByClassName("remark-slides-area");
  if (!el) return;
  var slide, slides = slideshow.getSlides(), els = el[0].children;
  for (var i = 1; i < slides.length; i++) {
    slide = slides[i];
    if (slide.properties.continued === "true" || slide.properties.count === "false") {
      els[i - 1].className += ' has-continuation';
    }
  }
  var s = d.createElement("style");
  s.type = "text/css"; s.innerHTML = "@media print { .has-continuation { display: none; } }";
  d.head.appendChild(s);
})(document);
// delete the temporary CSS (for displaying all slides initially) when the user
// starts to view slides
(function() {
  var deleted = false;
  slideshow.on('beforeShowSlide', function(slide) {
    if (deleted) return;
    var sheets = document.styleSheets, node;
    for (var i = 0; i < sheets.length; i++) {
      node = sheets[i].ownerNode;
      if (node.dataset["target"] !== "print-only") continue;
      node.parentNode.removeChild(node);
    }
    deleted = true;
  });
})();
(function() {
  "use strict"
  // Replace <script> tags in slides area to make them executable
  var scripts = document.querySelectorAll(
    '.remark-slides-area .remark-slide-container script'
  );
  if (!scripts.length) return;
  for (var i = 0; i < scripts.length; i++) {
    var s = document.createElement('script');
    var code = document.createTextNode(scripts[i].textContent);
    s.appendChild(code);
    var scriptAttrs = scripts[i].attributes;
    for (var j = 0; j < scriptAttrs.length; j++) {
      s.setAttribute(scriptAttrs[j].name, scriptAttrs[j].value);
    }
    scripts[i].parentElement.replaceChild(s, scripts[i]);
  }
})();
(function() {
  var links = document.getElementsByTagName('a');
  for (var i = 0; i < links.length; i++) {
    if (/^(https?:)?\/\//.test(links[i].getAttribute('href'))) {
      links[i].target = '_blank';
    }
  }
})();
// adds .remark-code-has-line-highlighted class to <pre> parent elements
// of code chunks containing highlighted lines with class .remark-code-line-highlighted
(function(d) {
  const hlines = d.querySelectorAll('.remark-code-line-highlighted');
  const preParents = [];
  const findPreParent = function(line, p = 0) {
    if (p > 1) return null; // traverse up no further than grandparent
    const el = line.parentElement;
    return el.tagName === "PRE" ? el : findPreParent(el, ++p);
  };

  for (let line of hlines) {
    let pre = findPreParent(line);
    if (pre && !preParents.includes(pre)) preParents.push(pre);
  }
  preParents.forEach(p => p.classList.add("remark-code-has-line-highlighted"));
})(document);</script>
<style>
.logo {
  background-image: url(images/fws-logo.png);
  background-size: contain;
  background-repeat: no-repeat;
  position: absolute;
  bottom: 0.5em;
  left: 0.5em;
  width: 100px;
  height: 60px;
  z-index: 0;
}
</style>

<script>
document
  .querySelectorAll(
    '.remark-slide-content' +
    ':not(.title-slide)' +
    // add additional classes to exclude here, e.g.
    // ':not(.inverse)' +
    ':not(.hide-logo)'
  )
  .forEach(el => {
    el.innerHTML += '<div class="logo"></div>';
  });
</script>

<style>
.github {
  background-image: url(https://github.blog/wp-content/uploads/2008/12/forkme_right_darkblue_121621.png?resize=149%2C149);
  background-size: contain;
  background-repeat: no-repeat;
  position: absolute;
  top: 0em;
  right: 0em;
  width: 100px;
  height: 100px;
  z-index: 0;
  
}
</style>

<script>
slideshow._releaseMath = function(el) {
  var i, text, code, codes = el.getElementsByTagName('code');
  for (i = 0; i < codes.length;) {
    code = codes[i];
    if (code.parentNode.tagName !== 'PRE' && code.childElementCount === 0) {
      text = code.textContent;
      if (/^\\\((.|\s)+\\\)$/.test(text) || /^\\\[(.|\s)+\\\]$/.test(text) ||
          /^\$\$(.|\s)+\$\$$/.test(text) ||
          /^\\begin\{([^}]+)\}(.|\s)+\\end\{[^}]+\}$/.test(text)) {
        code.outerHTML = code.innerHTML;  // remove <code></code>
        continue;
      }
    }
    i++;
  }
};
slideshow._releaseMath(document);
</script>
<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
(function () {
  var script = document.createElement('script');
  script.type = 'text/javascript';
  script.src  = 'https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML';
  if (location.protocol !== 'file:' && /^https?:/.test(script.src))
    script.src  = script.src.replace(/^https?:/, '');
  document.getElementsByTagName('head')[0].appendChild(script);
})();
</script>
  </body>
</html>
